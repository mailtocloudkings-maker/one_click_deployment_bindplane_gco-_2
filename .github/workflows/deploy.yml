name: BindPlane One-Click Deploy

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repository
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # 3️⃣ Authenticate to GCP
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 4️⃣ Install jq (needed for API key generation)
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # 5️⃣ Terraform Init
      - name: Terraform Init
        working-directory: terraform
        run: terraform init

      # 6️⃣ Step 1: Create VM + BindPlane Agent
      - name: Terraform Apply VM & Agent
        working-directory: terraform
        run: |
          terraform apply -target=google_compute_instance.bindplane_control \
            -auto-approve \
            -var="project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var="region=${{ secrets.GCP_REGION }}" \
            -var="zone=${{ secrets.GCP_ZONE }}" \
            -var="alert_email=${{ secrets.ALERT_EMAIL }}"

      # 7️⃣ Step 2: Generate BindPlane API Key
      - name: Generate BindPlane API Key
        working-directory: terraform
        run: |
          SERVER_IP=$(terraform output -raw bindplane_vm_ip)
          echo "Waiting 30 seconds for BindPlane server to be ready..."
          sleep 30
          TOKEN=$(curl -s -X POST http://$SERVER_IP:3001/v1/session \
            -H "Content-Type: application/json" \
            -d '{"username":"admin","password":"password*test"}' | jq -r '.token')
          API_KEY=$(curl -s -X POST http://$SERVER_IP:3001/v1/api-keys \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"name":"gha-key"}' | jq -r '.key')
          echo "bindplane_api_key=\"$API_KEY\"" > terraform/bindplane.auto.tfvars
          echo "✅ BindPlane API key generated and saved to bindplane.auto.tfvars"

      # 8️⃣ Step 3: Apply BindPlane Pipeline + GCS + GCO + Alerts
      - name: Terraform Apply Pipeline & Destinations
        working-directory: terraform
        run: |
          terraform apply -auto-approve \
            -var="project=${{ secrets.GCP_PROJECT_ID }}" \
            -var="zone=${{ secrets.GCP_ZONE }}" \
            -var="alert_email=${{ secrets.ALERT_EMAIL }}"
